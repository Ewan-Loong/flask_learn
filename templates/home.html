<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="stylesheet" href="/static/css/base.css">
    <meta charset="UTF-8"/>
    <title>ç»Ÿä¸€ç™»å½•ç®¡ç†</title>
    <style>

    </style>

</head>
<body data-api-base="/UserAuth">
<div class="main-layout">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="logo">ç»Ÿä¸€ç™»å½•ç®¡ç†</div>
        <div class="theme-toggle">
            <button id="themeToggle" class="btn btn-sm">
                ğŸ’¡ åˆ‡æ¢ä¸»é¢˜
            </button>
        </div>
        <div class="user-info">
            <div class="avatar" id="userAvatar">U</div> <!-- é»˜è®¤å¤´åƒ -->
            <div class="user-details">
                <div class="username" id="usernameDisplay">æœªç™»å½•</div>
                <div class="user-role" id="userRoleDisplay">-</div>
            </div>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar" id="sidebarMenu">
        <ul class="sidebar-menu">
            <li><a href="homepage/SysList.html" data-init="renderSystemsList">é¦–é¡µ</a></li>
            <li>
                <a href="#" class="has-submenu" data-init="initSystem">
                    ç³»ç»Ÿç®¡ç†<span class="arrow"></span>
                </a>
                <ul class="sidebar-submenu">
                    <li><a href="homepage/SysList.html" data-init="renderSystemsList">ç³»ç»Ÿåˆ—è¡¨</a></li>
                    <li><a href="#" data-init="initSysAdd">æ·»åŠ ç³»ç»Ÿ</a></li>
                    <li><a href="#" data-init="initSysUpdate">ä¿®æ”¹ç³»ç»Ÿ</a></li>
                </ul>
            </li>
            <li>
                <a href="#" class="has-submenu" data-init="initUser">
                    ç”¨æˆ·ç®¡ç†<span class="arrow"></span>
                </a>
                <ul class="sidebar-submenu">
                    <li><a href="#" data-init="initUserList">ç”¨æˆ·åˆ—è¡¨</a></li>
                    <li><a href="#" data-init="initUserAdd">æ–°å¢ç”¨æˆ·</a></li>
                    <li><a href="#" data-init="initUserUpdate">ä¿®æ”¹ç”¨æˆ·</a></li>
                </ul>
            </li>
            <li><a href="#" id="logout">é€€å‡ºç™»å½•</a></li>
        </ul>
    </aside>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="main-content">
        <p>è¯·é€‰æ‹©ä¸€ä¸ªé¡µé¢ã€‚</p>
    </div>
</div>
<script type="module" src="/static/js/api.js"></script>
<script type="module" src="/static/js/base.js"></script>
<script type="module">
    import {UserAuth} from '/static/js/api.js';
    import {Loading, MsgQ, checkStoredToken, logout} from '/static/js/base.js';
    import {renderSystemsList} from '/static/js/homepage/init.js';

    // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ˜ å°„è¡¨
    const PageInitFunctions = {
        renderSystemsList: renderSystemsList,
        // å…¶ä»–åˆå§‹åŒ–å‡½æ•°...
    };

    // å£°æ˜å…¨å±€å˜é‡å­˜å‚¨ token å’Œç”¨æˆ·ä¿¡æ¯
    let globalToken = localStorage.getItem('Token');
    let currentUserInfo = JSON.parse(localStorage.getItem('user'));

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        setupMenuBar();
        // setupLogoutButton();
        // setupNavigation();
        // setupUserManagementForms();

        // å°è¯•ä»localStorageæ¢å¤ç™»å½•çŠ¶æ€ (å¯é€‰)
        checkStoredToken();

        document.getElementById('logout').addEventListener('click', logout);
    });

    // è®¾ç½®èœå•æ äº‹ä»¶
    function setupMenuBar() {

        // æ‰€æœ‰å¯ç‚¹å‡»çš„èœå•é¡¹ï¼ˆæ’é™¤æœ‰å­èœå•ä½†ä¸æ˜¯å¶å­èŠ‚ç‚¹çš„ï¼‰
        const menuLinks = document.querySelectorAll('.sidebar-menu a[href]:not(.has-submenu), .sidebar-menu .sidebar-submenu a[href]');
        console.log(menuLinks)
        menuLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è·³è½¬

                const url = this.getAttribute('href');
                const initFunctionName = this.getAttribute('data-init');

                // æ›´æ–°é«˜äº®çŠ¶æ€
                document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
                this.classList.add('active');

                // æ›´æ–° active-parent
                updateActiveParentClasses();

                // åŠ è½½é¡µé¢å†…å®¹
                loadPage(url, initFunctionName);
            });
        });


        // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªé¡µé¢ï¼ˆå¯é€‰ï¼‰
        if (menuLinks.length > 0) {
            menuLinks[0].click();
        }
    }

    // åŠ è½½é¡µé¢å†…å®¹å¹¶æ‰§è¡Œåˆå§‹åŒ–å‡½æ•°
    async function loadPage(url, initFunctionName) {
        // const mainContent = document.getElementsByClassName('main-content')[0];
        const mainContent = document.querySelector('.main-content');

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`åŠ è½½å¤±è´¥: ${url}`);

            const html = await response.text();
            // æ’å…¥ HTMLï¼ˆåªå– body å†…å®¹ï¼Œé¿å…é‡å¤ headï¼‰
            mainContent.innerHTML = `
      <div data-page="${url}" style="width: 100%;height: 100%">
        ${extractBodyContent(html)}
      </div>
    `;

            // æ‰§è¡Œåˆå§‹åŒ–å‡½æ•°ï¼ˆå¦‚æœå®šä¹‰äº†ï¼‰
            // if (initFunctionName && window[initFunctionName]) {
            //     window[initFunctionName]();
            // } else if (initFunctionName) {
            //     MsgQ.warning(`âš ï¸ åˆå§‹åŒ–å‡½æ•°æœªå®šä¹‰: ${initFunctionName}`);
            // }

            // æ‰§è¡Œåˆå§‹åŒ–å‡½æ•°ï¼ˆå¦‚æœå®šä¹‰äº†ï¼‰
            if (initFunctionName && PageInitFunctions[initFunctionName]) {
                PageInitFunctions[initFunctionName]();
            } else if (initFunctionName) {
                MsgQ.warning(`âš ï¸ åˆå§‹åŒ–å‡½æ•°æœªå®šä¹‰: ${initFunctionName}`);
            }

        } catch (err) {
            mainContent.innerHTML = `<p style="color:red;">åŠ è½½é¡µé¢å¤±è´¥: ${err.message}</p>`;
            console.error(err)
            MsgQ.error(err);
        }
    }

    // æå– HTML æ–‡ä»¶ä¸­çš„ body å†…å®¹ï¼ˆå»é™¤ <head> ç­‰ï¼‰
    function extractBodyContent(html) {
        const div = document.createElement('div');
        div.innerHTML = html;
        const bodyContent = div.querySelector('body') || div;
        return bodyContent.innerHTML || bodyContent.textContent;
    }

    // æ›´æ–° active-parent ç±»
    function updateActiveParentClasses() {
        document.querySelectorAll('.sidebar-menu li').forEach(li => {
            li.classList.remove('active-parent');
            if (li.querySelector('.sidebar-submenu a.active')) {
                li.classList.add('active-parent');
            }
        });
    }

    // è®¾ç½®å¯¼èˆªæŒ‰é’®
    function setupNavigation() {
        document.getElementById('showSystemsBtn').addEventListener('click', showSystemsView);
        document.getElementById('showCreateUserBtn').addEventListener('click', showCreateUserView);
        document.getElementById('showUpdateUserBtn').addEventListener('click', showUpdateUserView);
    }

    function showSystemsView() {
        document.getElementById('contentArea').querySelectorAll('div[id$="Area"]').forEach(el => el.style.display = 'none');
        document.getElementById('systemsGridArea').style.display = 'block';
        document.querySelectorAll('.btn-primary').forEach(btn => btn.classList.remove('active'));
        document.getElementById('showSystemsBtn').classList.add('active');
    }

    function showCreateUserView() {
        document.getElementById('contentArea').querySelectorAll('div[id$="Area"]').forEach(el => el.style.display = 'none');
        document.getElementById('createUserArea').style.display = 'block';
        document.querySelectorAll('.btn-primary').forEach(btn => btn.classList.remove('active'));
        document.getElementById('showCreateUserBtn').classList.add('active');
    }

    function showUpdateUserView() {
        document.getElementById('contentArea').querySelectorAll('div[id$="Area"]').forEach(el => el.style.display = 'none');
        document.getElementById('updateUserArea').style.display = 'block';
        document.querySelectorAll('.btn-primary').forEach(btn => btn.classList.remove('active'));
        document.getElementById('showUpdateUserBtn').classList.add('active');

        // å¡«å……æ›´æ–°è¡¨å•
        if (currentUserInfo) {
            document.getElementById('updatedUsername').value = currentUserInfo.name;
            document.getElementById('updatedEmail').value = currentUserInfo.email || '';
        }
    }

    // è®¾ç½®ç”¨æˆ·ç®¡ç†è¡¨å•äº‹ä»¶
    function setupUserManagementForms() {
        // åˆ›å»ºç”¨æˆ·è¡¨å•
        document.getElementById('createUserForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            await createUser();
        });

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯è¡¨å•
        document.getElementById('updateUserForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            await updateUserInfo();
        });
    }

    // åˆ›å»ºç”¨æˆ·
    async function createUser() {
        const newUsername = document.getElementById('newUsername').value.trim();
        const newPassword = document.getElementById('newPassword').value;

        if (!newUsername || !newPassword) {
            MsgQ.warning('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚');
            return;
        }

        try {
            const response = await request.post('/create_user', {
                name: newUsername,
                passwd: newPassword
            }, {
                headers: {
                    'Authorization': `Bearer ${globalToken}`,
                    'Token': globalToken,
                    'Content-Type': 'application/json'
                },
                timeout: 10000
            });


            if (response.data && response.data.msg && response.data.msg.includes('æˆåŠŸ')) {
                MsgQ.success('ç”¨æˆ·åˆ›å»ºæˆåŠŸã€‚');
                document.getElementById('createUserForm').reset();
            } else {
                MsgQ.error(`åˆ›å»ºç”¨æˆ·å¤±è´¥ï¼š${response.data.msg || 'æœªçŸ¥é”™è¯¯'}`);
            }
        } catch (error) {
            MsgQ.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
            let errorMessage = 'åˆ›å»ºç”¨æˆ·å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚';
            if (error.response) {
                errorMessage = `åˆ›å»ºç”¨æˆ·å¤±è´¥ï¼š${error.response.status} ${error.response.statusText}`;
                if (error.response.data && error.response.data.msg) {
                    errorMessage = `åˆ›å»ºç”¨æˆ·å¤±è´¥ï¼š${error.response.data.msg}`;
                }
            }
            MsgQ.error(errorMessage);
        }
    }

    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    async function updateUserInfo() {
        const updatedPassword = document.getElementById('updatedPassword').value;
        const updatedEmail = document.getElementById('updatedEmail').value;

        if (!updatedPassword && !updatedEmail) {
            MsgQ.error('è¯·è‡³å°‘å¡«å†™å¯†ç æˆ–é‚®ç®±ä¸€é¡¹ã€‚');
            return;
        }

        try {

            const updateData = {
                name: currentUserInfo.name
            };
            if (updatedPassword) updateData.passwd = updatedPassword;
            if (updatedEmail) updateData.email = updatedEmail;

            const response = await request.post('http://127.0.0.1:5000/UserAuth/update_user', updateData, {
                headers: {
                    'Authorization': `Bearer ${globalToken}`,
                    'token': globalToken,
                    'Content-Type': 'application/json'
                },
                timeout: 10000
            });

            if (response.data && response.data.msg && response.data.msg.includes('æˆåŠŸ')) {
                MsgQ.success('ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸã€‚');
                // é‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
                await loadUserInfo();
            } else {
                MsgQ.error(`æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š${response.data.msg || 'æœªçŸ¥é”™è¯¯'}`);
            }
        } catch (error) {
            let errorMessage = 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚';
            if (error.response) {
                errorMessage = `æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š${error.response.status} ${error.response.statusText}`;
                if (error.response.data && error.response.data.msg) {
                    errorMessage = `æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š${error.response.data.msg}`;
                }
            }
            MsgQ.error(errorMessage);
        }
    }

</script>
</body>
</html>